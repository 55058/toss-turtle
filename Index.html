<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Toss-style demo (with save/load)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    html,body{height:100%;margin:0;font-family:system-ui,Segoe UI,Roboto,Arial}
    .wrap{display:grid;grid-template-columns:1fr 320px;height:100vh;gap:12px;padding:12px;box-sizing:border-box}
    #game{background:#bfeaff;border:2px solid #223;display:flex;align-items:flex-end;justify-content:center;overflow:hidden;position:relative}
    canvas{background:linear-gradient(#a8e6ff,#6fc6ff);display:block;width:100%;height:100%}
    .panel{background:#fff;border:1px solid #ccc;padding:12px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.06)}
    h2{margin:0 0 8px 0;font-size:16px}
    .stat{font-weight:700;font-size:18px;margin:6px 0}
    button{display:inline-block;padding:8px 10px;margin:6px 6px 6px 0;border-radius:6px;border:1px solid #888;background:#f3f3f3;cursor:pointer}
    .meter{height:10px;background:#eee;border-radius:6px;overflow:hidden;margin-top:4px}
    .meter > i{display:block;height:100%;width:0;background:linear-gradient(#ffd,#f80)}
    .upgrade{margin-top:8px;padding:8px;border-radius:6px;background:#fafafa;border:1px dashed #bbb}
    .footer{font-size:12px;color:#666;margin-top:8px}
    #saveStatus{font-size:12px;color:green;margin-left:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <div id="game" class="panel">
      <canvas id="c"></canvas>
      <div style="position:absolute;left:12px;top:12px;background:rgba(255,255,255,0.85);padding:6px;border-radius:6px">
        <div>Click to set angle/power → release to fire</div>
        <div style="font-size:12px;color:#444">Click and drag to aim</div>
      </div>
    </div>

    <div class="panel" style="display:flex;flex-direction:column">
      <h2>Progress & Controls</h2>
      <div class="stat">Distance: <span id="distance">0</span> m</div>
      <div class="stat">Money: $<span id="money">0</span></div>
      <div class="stat">Best: <span id="best">0</span> m</div>

      <div style="margin-top:8px;">
        <button id="launchBtn">Launch</button>
        <button id="resetBtn">Reset Run</button>
      </div>

      <div style="margin-top:10px">
        <div>Power</div>
        <div class="meter" style="width:100%"><i id="powerMeter"></i></div>
        <div style="font-size:13px;margin-top:6px">Angle: <span id="angleDisp">45</span>°</div>
      </div>

      <div class="upgrade">
        <div style="font-weight:700">Upgrades</div>
        <div>Power Boost (+20 initial velocity)</div>
        <div style="margin-top:6px">
          <button id="buyPower">Buy Power (+20)</button>
          <span style="margin-left:8px">Cost: $<span id="powerCost">100</span></span>
        </div>
      </div>

      <div style="margin-top:12px">
        <button id="saveBtn">Save Now</button>
        <button id="loadBtn">Load</button>
        <button id="clearBtn">Clear Save</button>
        <span id="saveStatus"></span>
      </div>

      <div class="footer">
        Auto-save: on (also saved on events). Host this file on GitHub Pages and embed with an iframe into Google Sites.
      </div>
    </div>
  </div>

<script>
/* Simple toss-style prototype with localStorage save/load */
(() => {
  const canvas = document.getElementById('c');
  const ctx = canvas.getContext('2d');
  const DIST_SCALE = 1; // 1 px == 1 meter (for display only)
  let W = 800, H = 600;
  function resize(){ W = canvas.width = canvas.clientWidth * devicePixelRatio; H = canvas.height = canvas.clientHeight * devicePixelRatio; ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0) }
  window.addEventListener('resize', resize);
  resize();

  // Game state
  const saveKey = 'toss_clone_save_v1';
  let game = {
    money: 0,
    best: 0,
    upgrades: { powerBoost: 0 },
    lastRunDistance: 0
  };

  // projectile and simulation
  let projectile = null;
  const gravity = 9.8 * 60; // px/s^2 (scaled)
  const ground = H / devicePixelRatio - 60;
  let isAiming = false;
  let aim = {x:100, y:ground, angle:45, power:0};
  const maxPower = 100; // UI power
  let mouse = {x:0,y:0};

  // UI refs
  const distanceEl = document.getElementById('distance');
  const moneyEl = document.getElementById('money');
  const bestEl = document.getElementById('best');
  const powerMeter = document.getElementById('powerMeter');
  const angleDisp = document.getElementById('angleDisp');
  const saveStatus = document.getElementById('saveStatus');
  const powerCostEl = document.getElementById('powerCost');

  function updateUI(){
    distanceEl.textContent = Math.round(game.lastRunDistance);
    moneyEl.textContent = Math.round(game.money);
    bestEl.textContent = Math.round(game.best);
    powerCostEl.textContent = 100 + 50 * game.upgrades.powerBoost;
  }

  function saveGame(showBrief=true){
    localStorage.setItem(saveKey, JSON.stringify(game));
    if (showBrief) {
      saveStatus.textContent = 'Saved ✓';
      setTimeout(()=> saveStatus.textContent = '',1200);
    }
  }
  function loadGame(){
    const raw = localStorage.getItem(saveKey);
    if (raw){
      try{
        const obj = JSON.parse(raw);
        game = Object.assign(game, obj);
        updateUI();
        saveStatus.textContent = 'Loaded ✓';
        setTimeout(()=> saveStatus.textContent = '',1200);
        return true;
      }catch(e){ console.warn(e) }
    }
    saveStatus.textContent = 'No save found';
    setTimeout(()=> saveStatus.textContent = '',1200);
    return false;
  }
  function clearSave(){
    localStorage.removeItem(saveKey);
    saveStatus.textContent = 'Save cleared';
    setTimeout(()=> saveStatus.textContent = '',1200);
  }

  // Launch mechanic
  function getInitialVelocity(power){
    // base speed
    let base = 8 * (power/20); // tuned
    base += game.upgrades.powerBoost * 20 / 100; // each upgrade small multiplier
    return base * 60; // px/s
  }

  function launch(angleDeg, power){
    const angle = angleDeg * Math.PI/180;
    const speed = getInitialVelocity(power);
    projectile = {
      x: aim.x,
      y: aim.y - 10,
      vx: Math.cos(angle) * speed,
      vy: -Math.sin(angle) * speed,
      t: 0
    };
  }

  // Mouse / aiming handlers
  const gameDiv = document.getElementById('game');
  gameDiv.addEventListener('pointerdown', e => {
    isAiming = true;
    mouse.x = e.clientX - gameDiv.getBoundingClientRect().left;
    mouse.y = e.clientY - gameDiv.getBoundingClientRect().top;
  });
  window.addEventListener('pointermove', e => {
    if (!isAiming) return;
    mouse.x = e.clientX - gameDiv.getBoundingClientRect().left;
    mouse.y = e.clientY - gameDiv.getBoundingClientRect().top;
    const dx = mouse.x - aim.x;
    const dy = (gameDiv.clientHeight - mouse.y) - (gameDiv.clientHeight - aim.y);
    // compute angle and power
    let ang = Math.atan2((aim.y - mouse.y), (mouse.x - aim.x));
    ang = Math.max(5, Math.min(85, (ang * 180/Math.PI)));
    aim.angle = ang;
    // power by distance of drag
    const dist = Math.hypot(mouse.x - aim.x, mouse.y - aim.y);
    aim.power = Math.max(10, Math.min(maxPower, dist / 1.5));
    angleDisp.textContent = Math.round(aim.angle);
    powerMeter.style.width = Math.round((aim.power / maxPower) * 100) + '%';
    powerMeter.firstElementChild.style.width = Math.round((aim.power / maxPower) * 100) + '%';
  });
  window.addEventListener('pointerup', e => {
    if (!isAiming) return;
    isAiming = false;
    // fire
    launch(aim.angle, aim.power);
  });

  // Buttons
  document.getElementById('launchBtn').addEventListener('click', ()=> launch(aim.angle, Math.max(20, aim.power || 40)));
  document.getElementById('resetBtn').addEventListener('click', ()=> { projectile = null; game.lastRunDistance = 0; updateUI(); });
  document.getElementById('buyPower').addEventListener('click', ()=>{
    const cost = 100 + 50 * game.upgrades.powerBoost;
    if (game.money >= cost){
      game.money -= cost;
      game.upgrades.powerBoost += 1;
      saveGame();
      updateUI();
    } else {
      saveStatus.textContent = 'Not enough $';
      setTimeout(()=> saveStatus.textContent = '',1200);
    }
  });

  document.getElementById('saveBtn').addEventListener('click', ()=> saveGame(true));
  document.getElementById('loadBtn').addEventListener('click', ()=> { loadGame(); draw(); });
  document.getElementById('clearBtn').addEventListener('click', ()=> { clearSave(); });

  // Simulation loop
  let last = performance.now();
  function step(now){
    const dt = (now - last)/1000;
    last = now;
    if (projectile){
      projectile.t += dt;
      projectile.vy += gravity * dt;
      projectile.x += projectile.vx * dt;
      projectile.y += projectile.vy * dt;
      // hit ground?
      if (projectile.y >= ground){
        // landed
        const dist = (projectile.x - aim.x) / DIST_SCALE;
        game.lastRunDistance = Math.max(0, Math.round(dist));
        // reward: $ per m
        const earned = Math.max(0, Math.round(game.lastRunDistance * 0.6));
        game.money += earned;
        if (game.lastRunDistance > game.best) game.best = game.lastRunDistance;
        projectile = null;
        saveGame(false); // auto save
        updateUI();
      }
    }
    draw();
    requestAnimationFrame(step);
  }

  function draw(){
    const cw = canvas.clientWidth, ch = canvas.clientHeight;
    // clear
    ctx.clearRect(0,0,cw,ch);
    // ground
    ctx.fillStyle = '#6c4';
    ctx.fillRect(0, ground, cw, ch-ground);

    // draw launch pad
    ctx.fillStyle = '#663';
    ctx.fillRect(aim.x - 20, ground - 8, 40, 8);

    // draw aim indicator
    const ax = aim.x, ay = aim.y - 10;
    const ang = aim.angle * Math.PI/180;
    ctx.strokeStyle = 'rgba(0,0,0,0.65)';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(ax, ay);
    ctx.lineTo(ax + Math.cos(ang)*40, ay - Math.sin(ang)*40);
    ctx.stroke();

    // projectile
    if (projectile){
      ctx.fillStyle = '#0af';
      ctx.beginPath();
      ctx.arc(projectile.x, projectile.y, 12, 0, Math.PI*2);
      ctx.fill();

      // trail (simple)
      ctx.fillStyle = 'rgba(0,0,0,0.06)';
      ctx.fillRect(projectile.x - 2, projectile.y - 2, 4, 4);
    } else {
      // draw turtle at pad
      ctx.fillStyle = '#0f7';
      ctx.beginPath();
      ctx.ellipse(aim.x + 10, aim.y - 14, 14, 10, 0, 0, Math.PI*2);
      ctx.fill();
      ctx.fillStyle = '#000';
      ctx.beginPath(); ctx.arc(aim.x + 16, aim.y - 18, 2, 0, Math.PI*2); ctx.fill();
    }

    // horizon/labels
    ctx.fillStyle = '#333';
    ctx.font = '14px system-ui';
    ctx.fillText('Last run: ' + Math.round(game.lastRunDistance) + ' m', 10, 20);
    ctx.fillText('Best: ' + Math.round(game.best) + ' m', 10, 40);
    ctx.fillText('Money: $' + Math.round(game.money), 10, 60);
  }

  // Init
  loadGame();
  updateUI();
  last = performance.now();
  requestAnimationFrame(step);

  // Autosave periodically and on unload
  setInterval(()=> saveGame(false), 5000);
  window.addEventListener('beforeunload', ()=> saveGame(false));
})();
</script>
</body>
</html>